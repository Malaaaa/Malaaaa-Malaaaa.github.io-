<!doctype html>
<html class="docs-version-current" lang="zh-CN" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.17">
<title data-rh="true">Linking | My resume</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://malaaa.mljlls.tech//zh-CN/docs/CSAPP/Linking"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Linking | My resume"><meta data-rh="true" name="description" content="Translates the example program from an ASCII source file into an executable object file."><meta data-rh="true" property="og:description" content="Translates the example program from an ASCII source file into an executable object file."><link data-rh="true" rel="icon" href="/zh-CN/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://malaaa.mljlls.tech//zh-CN/docs/CSAPP/Linking"><link data-rh="true" rel="alternate" href="https://malaaa.mljlls.tech//docs/CSAPP/Linking" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://malaaa.mljlls.tech//fr/docs/CSAPP/Linking" hreflang="fr"><link data-rh="true" rel="alternate" href="https://malaaa.mljlls.tech//zh-CN/docs/CSAPP/Linking" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://malaaa.mljlls.tech//docs/CSAPP/Linking" hreflang="x-default"><link rel="stylesheet" href="/zh-CN/assets/css/styles.76dd682a.css">
<link rel="preload" href="/zh-CN/assets/js/runtime~main.89956f3e.js" as="script">
<link rel="preload" href="/zh-CN/assets/js/main.90a4a23c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">跳转到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-CN/"><div class="navbar__logo"><img src="/zh-CN/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/zh-CN/img/logo.svg" alt="My Site Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">我的恢复</b></a><a class="navbar__item navbar__link navbar__link--active" href="/zh-CN/docs/intro">我的笔记</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Malaaaa" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg><span>中文（中国）</span></span></a><ul class="dropdown__menu"><li><a href="/docs/CSAPP/Linking" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/fr/docs/CSAPP/Linking" target="_self" rel="noopener noreferrer" class="dropdown__link">Français</a></li><li><a href="/zh-CN/docs/CSAPP/Linking" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">中文（中国）</a></li></ul></div><div class="toggle_S7eR toggle_TdHA toggleDisabled_f9M3"><div class="toggleButton_rCf9" role="button" tabindex="-1"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></div><input type="checkbox" class="toggleScreenReader_g2nN" aria-label="在暗色和亮色模式之间切换(当前为 亮色模式)"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="回滚到顶部" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh-CN/docs/intro">简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh-CN/docs/ReadingNote">Books</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/zh-CN/docs/CSAPP/CSAPPNOTE">CSAPP</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/CSAPP/CSAPPNOTE">Computer Systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/CSAPP/Exceptional Control Flow">Exceptional Control Flow</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/zh-CN/docs/CSAPP/I/O">一</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/zh-CN/docs/CSAPP/Linking">Linking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh-CN/docs/CSAPP/Network">Network</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/zh-CN/docs/Flutter/">流体</a><button aria-label="切换可折叠侧边栏类别流体&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh-CN/docs/HomeChain">HomeChain</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/zh-CN/docs/JavaScript/">JavaScript</a><button aria-label="切换可折叠侧边栏类别JavaScript&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh-CN/docs/Linux/WSL/LAMP">Linux</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh-CN/docs/LinuxConfigNote">Note</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh-CN/docs/NetworkBS">计算机网络基础</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link" href="/zh-CN/docs/Nodejs/">Nodejs</a><button aria-label="切换可折叠侧边栏类别Nodejs&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh-CN/docs/React/HookUse">React</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh-CN/docs/Skill/IDE">技能</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/zh-CN/docs/TypeScript/Generics">TypeScript</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh-CN/docs/Web-Note">Web notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zh-CN/docs/docsify">对齐化</a></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/zh-CN/">🏠</a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link breadcrumbsItemLink_e5ie">CSAPP</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><a class="breadcrumbs__link breadcrumbsItemLink_e5ie" href="/zh-CN/docs/CSAPP/Linking">Linking</a></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">在本页</button></div><div class="theme-doc-markdown markdown"><header><h1>Linking</h1></header><h3 class="anchor anchorWithStickyNavbar_mojV" id="translates-the-example-program-from-an-ascii-source-file-into-an-executable-object-file">Translates the example program from an ASCII source file into an executable object file.<a class="hash-link" href="#translates-the-example-program-from-an-ascii-source-file-into-an-executable-object-file" title="直接链接到标题">​</a></h3><p><img loading="lazy" alt="img_6.png" src="/zh-CN/assets/images/img_6-ce6a03bde9531a6cbe27f45be64d85e2.png" width="554" height="141"></p><ol><li>C preprocessor: cpp <!-- -->[other arguments]<!-- --> hello.c /tmp/main.i</li><li>C compiler: cc1 /tmp/hello.i -Og <!-- -->[other arguments]<!-- --> -o /tmp/hello.s</li><li>assembler: as <!-- -->[other arguments]<!-- --> -o /tmp/hello.o /tmp/hello.s</li><li>linker program: ld -o hello <!-- -->[system object files and args]<!-- --> /tmp/hello.o /libc.a/printf.o</li><li>executable prog: linux&gt; ./hello</li></ol><h3 class="anchor anchorWithStickyNavbar_mojV" id="object-files">Object Files<a class="hash-link" href="#object-files" title="直接链接到标题">​</a></h3><p>Executable and Linkable Format(ELF).
<img loading="lazy" alt="img_3.png" src="/zh-CN/assets/images/img_3-f6ba88724de654678c793e808d4d1437.png" width="824" height="684"></p><ul><li><p>.text The machine code of the compiled program.</p></li><li><p>.rodata <strong>Read-only</strong> data such as the format strings in printf statements, and
jump tables for switch statements.</p></li><li><p>.data Initialized global and static C variables. Local C variables are maintained
at run time on the stack and do not appear in either the .data or .bss
sections.</p></li><li><p>.bss Uninitialized global and static C variables, along with any global or static
variables that are initialized to zero. No space have same addresses with .comment.</p></li><li><p>.symtab A symbol table with information about functions and global variables
that are defined and referenced in the program.</p></li><li><p>.rel Relocation information</p></li><li><p>.line A mapping line numbers</p></li><li><p>.strtab A string table</p></li><li><p>Relocatable object file. Contains binary code and data in a form that can be combined with other relocatable object files at compile time to create an executable object file.</p></li><li><p>Executable object file. Contains binary code and data in a form that can be copied directly into memory and executed.
<img loading="lazy" alt="img_2.png" src="/zh-CN/assets/images/img_2-7ea081012bfb8ce50223762d38db5d56.png" width="1236" height="694"></p></li><li><p>Shared object file. A special type of relocatable object file that can be loaded into memory and linked dynamically, at either load time or run time.</p></li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="symbols">Symbols<a class="hash-link" href="#symbols" title="直接链接到标题">​</a></h4><ul><li>Global symbols defined by module m and that can be referenced by
other modules. OR referenced by module m but defined by some other
module.</li><li>Local symbols that are defined and referenced exclusively by module m.</li></ul><h6 class="anchor anchorWithStickyNavbar_mojV" id="how-linkers-resolve-duplicate-symbol-names">How Linkers Resolve Duplicate Symbol Names<a class="hash-link" href="#how-linkers-resolve-duplicate-symbol-names" title="直接链接到标题">​</a></h6><p>strong symbols: int i = 1;
weak symbols: int i; int main(i =1); int <strong>attribute</strong>((weak)) power2(int x);int power2(int x) <strong>attribute</strong>((weak));extern int <strong>attribute</strong>((weak)) global_var;
Rule 1. Multiple strong symbols with the same name are not allowed.
Rule 2. Given a strong symbol and multiple weak symbols with the same name,
choose the strong symbol.
Rule 3. Given multiple weak symbols with the same name, choose any of the
weak symbols.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="relocation">Relocation<a class="hash-link" href="#relocation" title="直接链接到标题">​</a></h4><ol><li><p>Relocating sections and symbol definitions. In this step, the linker merges all
sections of the same type into a new aggregate section of the same type.</p></li><li><p>Relocating symbol references within sections. In this step, the linker modifies
every symbol reference in the bodies of the code and data sections so that
they point to the correct run-time addresses.</p></li></ol><p>Relocation entries for code are placed in .rel.text. Relocation entries for data
are placed in .rel.data.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">/*main.c*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void swap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int buf[2] = {1, 2};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    swap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/*swap.c*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extern int buf [] ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int *bufp0 = &amp;buf[0] ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int *bufp1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void swap() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int temp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bufp1 = &amp;buf[1];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    temp =*bufp0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *bufp0 = *bufp1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *bufp1 = temp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">malaaa@malaaa-N8xxEP6&gt; gcc -c swap.c -o swap.o//Relocatable object file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">malaaa@malaaa-N8xxEP6&gt; gcc -c main.c -o main.o//Relocatable object file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">malaaa@malaaa-N8xxEP6&gt; gcc -g swap.o main.o -o run//Executable object file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">malaaa@malaaa-N8xxEP6&gt; readelf -s swap.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">malaaa@malaaa-N8xxEP6&gt; readelf -s main.o</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>Result</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">swap.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Symbol table &#x27;.symtab&#x27; contains 14 entries:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS swap.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    8 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    9 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     8: 0000000000000000     0 SECTION LOCAL  DEFAULT   10 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     9: 0000000000000000     0 SECTION LOCAL  DEFAULT    7 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    10: 0000000000000000     8 OBJECT  GLOBAL DEFAULT    5 bufp0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    11: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND buf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    12: 0000000000000000     8 OBJECT  GLOBAL DEFAULT    4 bufp1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    13: 0000000000000000    67 FUNC    GLOBAL DEFAULT    1 swap</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>buf，是swap.o.symTable的条目，extern类型的符号，<strong>在main.o模块中定义！</strong>，我们看到一个关于全局符号 buf 定义的条目，它是从 .data 中偏移为 0 处开始的一个 8 字节的已初始化目标. \
bufp0：是swap.o.symTable的条目，global类型符号，在swap.o中定义，我们看到一个关于全局符号 bufpO 定义的条目，它是从 .data 中偏移为 0 处开始的一个 8 字节的已初始化目标 \ bufp1：是swap.o.symTabl的条目，global类型的符号，在swap.o中定义，它是一个未初始化的 8 字节数据目标（要求 8 字节对齐），最终当 这个模块被链接时它将作为一个 .bss 目标分配 \
swap：是swap.o.symTable的条目，func类型的符号，在swap.o中定义，它是一个位于 .text 中偏移为零处的 67 字节的函数。 \
temp：不属于swap.o.symTable条目，int类型的符号，在swap.o中定义，局部变量位于栈中管理。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">main.o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Symbol table &#x27;.symtab&#x27; contains 13 entries:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS main.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5: 0000000000000000     0 SECTION LOCAL  DEFAULT    6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6: 0000000000000000     0 SECTION LOCAL  DEFAULT    7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7: 0000000000000000     0 SECTION LOCAL  DEFAULT    8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8: 0000000000000000     0 SECTION LOCAL  DEFAULT    5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9: 0000000000000000     8 OBJECT  GLOBAL DEFAULT    3 buf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10: 0000000000000000    25 FUNC    GLOBAL DEFAULT    1 main</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">12: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND swap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>buf 是已经初始化的全局变量，一个位于.data节中偏移位0的8字节目标。 \
main 位于.text节中偏移为0的25字节函数</p><h6 class="anchor anchorWithStickyNavbar_mojV" id="objdump-relocation-entries">objdump relocation entries<a class="hash-link" href="#objdump-relocation-entries" title="直接链接到标题">​</a></h6><p><code>objdump -D -r swap.o</code> -d just .text
Result</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">swap.o:     file format elf64-x86-64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .text:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000000 &lt;swap&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0:   f3 0f 1e fa             endbr64 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   4:   55                      push   %rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   5:   48 89 e5                mov    %rsp,%rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   8:   48 8d 05 00 00 00 00    lea    0x0(%rip),%rax        # f &lt;swap+0xf&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b: R_X86_64_PC32    buf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   f:   48 89 05 00 00 00 00    mov    %rax,0x0(%rip)        # 16 &lt;swap+0x16&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            12: R_X86_64_PC32   bufp1-0x4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  16:   48 8b 05 00 00 00 00    mov    0x0(%rip),%rax        # 1d &lt;swap+0x1d&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            19: R_X86_64_PC32   bufp0-0x4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1d:   8b 00                   mov    (%rax),%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1f:   89 45 fc                mov    %eax,-0x4(%rbp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  22:   48 8b 15 00 00 00 00    mov    0x0(%rip),%rdx        # 29 &lt;swap+0x29&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            25: R_X86_64_PC32   bufp1-0x4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  29:   48 8b 05 00 00 00 00    mov    0x0(%rip),%rax        # 30 &lt;swap+0x30&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            2c: R_X86_64_PC32   bufp0-0x4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  30:   8b 12                   mov    (%rdx),%edx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  32:   89 10                   mov    %edx,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  34:   48 8b 05 00 00 00 00    mov    0x0(%rip),%rax        # 3b &lt;swap+0x3b&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            37: R_X86_64_PC32   bufp1-0x4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3b:   8b 55 fc                mov    -0x4(%rbp),%edx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3e:   89 10                   mov    %edx,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  40:   90                      nop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  41:   5d                      pop    %rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  42:   c3                      retq   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .bss:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000000 &lt;bufp1&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .data.rel:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000000 &lt;bufp0&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            0: R_X86_64_64  buf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .comment:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000000 &lt;.comment&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0:   00 47 43                add    %al,0x43(%rdi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   3:   43 3a 20                rex.XB cmp (%r8),%spl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   6:   28 55 62                sub    %dl,0x62(%rbp)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   9:   75 6e                   jne    79 &lt;swap+0x79&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   b:   74 75                   je     82 &lt;swap+0x82&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   d:   20 31                   and    %dh,(%rcx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   f:   30 2e                   xor    %ch,(%rsi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  11:   32 2e                   xor    (%rsi),%ch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  13:   30 2d 31 33 75 62       xor    %ch,0x62753331(%rip)        # 6275334a &lt;swap+0x6275334a&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  19:   75 6e                   jne    89 &lt;swap+0x89&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1b:   74 75                   je     92 &lt;swap+0x92&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1d:   31 29                   xor    %ebp,(%rcx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1f:   20 31                   and    %dh,(%rcx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  21:   30 2e                   xor    %ch,(%rsi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  23:   32 2e                   xor    (%rsi),%ch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  25:   30 00                   xor    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .note.gnu.property:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000000 &lt;.note.gnu.property&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0:   04 00                   add    $0x0,%al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   4:   10 00                   adc    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   6:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   8:   05 00 00 00 47          add    $0x47000000,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   d:   4e 55                   rex.WRX push %rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   f:   00 02                   add    %al,(%rdx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  11:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  13:   c0 04 00 00             rolb   $0x0,(%rax,%rax,1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  17:   00 03                   add    %al,(%rbx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  19:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1b:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1d:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .eh_frame:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000000 &lt;.eh_frame&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   0:   14 00                   adc    $0x0,%al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   4:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   6:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   8:   01 7a 52                add    %edi,0x52(%rdx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   b:   00 01                   add    %al,(%rcx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   d:   78 10                   js     1f &lt;.eh_frame+0x1f&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   f:   01 1b                   add    %ebx,(%rbx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  11:   0c 07                   or     $0x7,%al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  13:   08 90 01 00 00 1c       or     %dl,0x1c000001(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  19:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1b:   00 1c 00                add    %bl,(%rax,%rax,1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1e:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  20:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            20: R_X86_64_PC32   .text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  22:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  24:   43 00 00                rex.XB add %al,(%r8)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  27:   00 00                   add    %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  29:   45 0e                   rex.RB (bad) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2b:   10 86 02 43 0d 06       adc    %al,0x60d4302(%rsi)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  31:   7a 0c                   jp     3f &lt;swap+0x3f&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  33:   07                      (bad)  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  34:   08 00                   or     %al,(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="executable-object-files">Executable Object Files<a class="hash-link" href="#executable-object-files" title="直接链接到标题">​</a></h4><p><img loading="lazy" alt="img_4.png" src="/zh-CN/assets/images/img_4-920357f5483a3c3f2b2dfde382453ae8.png" width="1310" height="680">
Program header table <strong>Read only</strong></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="loading-executable-object-files">Loading Executable Object Files<a class="hash-link" href="#loading-executable-object-files" title="直接链接到标题">​</a></h4><p>The <strong>loader</strong> copies the code and data in the executable object file from disk into memory and then runs the program by jumping to its first instruction, or
entry point. \
the code segment starts at address 0x400000, 对于Linux而言，0X400000以下的空间默认不映射，从而起到保护程序安全的作用。对于windows而言，程序安全交由操作系统保证，因此最大限度利用资源，地址可以低到0X400000以下。  \
the data segment.\
the heap.\
the reserved for shared modules.\
the user stack. below the largest legal user address (2 48 − 1) and grows down, toward smaller memory addresses.\
the kernel.memory-resident part of the operating system.</p><p><img loading="lazy" alt="img_5.png" src="/zh-CN/assets/images/img_5-1312c575e79c44ef649452c1944c51c6.png" width="1014" height="940"></p><h4 class="anchor anchorWithStickyNavbar_mojV" id="static-linking">Static Linking<a class="hash-link" href="#static-linking" title="直接链接到标题">​</a></h4><ul><li>Symbol resolution.symbol: a function, a global variable, or a static variable (model &#x27;main(int i = 0)&#x27; is instruction)</li><li>Relocation.Compilers and assemblers generate code and data sections
that start at address 0.</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="dynamic-linking">Dynamic Linking<a class="hash-link" href="#dynamic-linking" title="直接链接到标题">​</a></h4><p>A <em>shared library</em> is an object module that, at either run time or load
time, can be loaded at an arbitrary memory address and linked with a program in
memory. \
Linux&#x27;s systems are indicated by the .so suffix. Microsoft operating systems make heavy use of shared libraries, which they refer to as DLLs</p><p>Shared libraries are “shared” in two different ways.</p><ol><li>exactly one .so file for a particular library. The code and data are shared by all executable object files that reference the library,</li><li>.text section in memory can be shared by different running processes.
<img loading="lazy" alt="img_7.png" src="/zh-CN/assets/images/img_7-3e602ac16c6f7bc20aa75cf5499d068d.png" width="1032" height="866"></li></ol><h5 class="anchor anchorWithStickyNavbar_mojV" id="the-dynamic-linker-then-finishes-the-linking-task-by-performing-the-following-relocations">The dynamic linker then finishes the linking task by performing the following relocations:<a class="hash-link" href="#the-dynamic-linker-then-finishes-the-linking-task-by-performing-the-following-relocations" title="直接链接到标题">​</a></h5><ul><li>Relocating the text and data of libc.so into some memory segment</li><li>Relocating the text and data of libvector.so into another memory segment</li><li>Relocating any references in prog2l to symbols defined by libc.so and libvector.so</li></ul><h5 class="anchor anchorWithStickyNavbar_mojV" id="dynamic-linking-is-a-powerful-and-useful-technique">Dynamic linking is a powerful and useful technique:<a class="hash-link" href="#dynamic-linking-is-a-powerful-and-useful-technique" title="直接链接到标题">​</a></h5><ul><li>Distributing software. use shared libraries to distribute software updates.</li><li>Building high-performance Web servers. generate dynamic
content using a more efficient and sophisticated approach based on dynamic
linking. subsequent requests can be handled at the cost of a simple function call.xisting
functions can be updated and new functions can be added at run time, without
stopping the server.</li></ul><h4 class="anchor anchorWithStickyNavbar_mojV" id="position-independent-code-pic">Position-Independent Code (PIC)<a class="hash-link" href="#position-independent-code-pic" title="直接链接到标题">​</a></h4><p>Code that can be loaded without needing any relocations is known as position-
independent code (PIC). Users direct GNU compilation systems to generate PIC
code with the -fpic option to gcc. Shared libraries must always be compiled with
this option.</p><p>链接器在可执行目标文件中的数据段新建了一个数据节.got
Global Offset Table, The GOT contains an 8-byte entry for each global data object that is referenced by the object module.The compiler also generates a relocation record for each entry in the GOT.
<img loading="lazy" alt="img_8.png" src="/zh-CN/assets/images/img_8-2c2e9c5bbe85954467a1e2ea069981b5.png" width="1320" height="568">
由于链接器无法修改编译器产生的汇编代码，所以无法修改调用共享库的函数的call指令，所以链接器在可执行目标文件的代码段新建一个.plt节对所有引用了共享库中的函数都在该数据节中创建一个新函数xxx@plt，然后将代码中调用地址替换成call xxx@plt，所以就能通过函数xxx@plt来完成对.got的更新，以及指向正确的地址。
the procedure linkage table (PLT).If an object module calls any functions that are defined in shared libraries, then it has its own GOT and PLT. The GOT is part of the data segment. The PLT is part of the code segment.
<code>Because addcnt is defined by the libvector.so module, the compiler can use the constant distance between the code segment and the data segment to generate a direct PC relative reference to addcnt, and add a relocation to let the linker construct this shared module Parse it. However, if addcnt is defined by another shared module, then indirect access via GOT is required. Here, the compiler chooses the most general solution, using GOT for all references.</code>\
<code>objdump -dx prog</code></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">000000000000077a &lt;main&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 77a:   48 83 ec 08             sub    $0x8,%rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 77e:   b9 02 00 00 00          mov    $0x2,%ecx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 783:   48 8d 15 9e 08 20 00    lea    0x20089e(%rip),%rdx        # 201028 &lt;z&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 78a:   48 8d 35 7f 08 20 00    lea    0x20087f(%rip),%rsi        # 201010 &lt;y&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 791:   48 8d 3d 80 08 20 00    lea    0x200880(%rip),%rdi        # 201018 &lt;x&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 798:   e8 a3 fe ff ff          callq  640 &lt;addvec@plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 79d:   8b 0d 89 08 20 00       mov    0x200889(%rip),%ecx        # 20102c &lt;z+0x4&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 7a3:   8b 15 7f 08 20 00       mov    0x20087f(%rip),%edx        # 201028 &lt;z&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 7a9:   48 8d 35 a4 00 00 00    lea    0xa4(%rip),%rsi        # 854 &lt;_IO_stdin_used+0x4&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 7b0:   bf 01 00 00 00          mov    $0x1,%edi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 7b5:   b8 00 00 00 00          mov    $0x0,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 7ba:   e8 91 fe ff ff          callq  650 &lt;__printf_chk@plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 7bf:   b8 00 00 00 00          mov    $0x0,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 7c4:   48 83 c4 08             add    $0x8,%rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 7c8:   c3                      retq   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 7c9:   0f 1f 80 00 00 00 00    nopl   0x0(%rax)</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>对addvec函数和对prinrf函数的调用转化为了对addvec@plt和对__printf_chk@plt函数的调用，这两个函数就是在.plt节中定义的，而.plt节中的内容如下所示</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .plt:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000630 &lt;.plt&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 630:   ff 35 82 09 20 00       pushq  0x200982(%rip)        # 200fb8 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 636:   ff 25 84 09 20 00       jmpq   *0x200984(%rip)        # 200fc0 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 63c:   0f 1f 40 00             nopl   0x0(%rax)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000640 &lt;addvec@plt&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 640:   ff 25 82 09 20 00       jmpq   *0x200982(%rip)        # 200fc8 &lt;addvec&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 646:   68 00 00 00 00          pushq  $0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 64b:   e9 e0 ff ff ff          jmpq   630 &lt;.plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000650 &lt;__printf_chk@plt&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 650:   ff 25 7a 09 20 00       jmpq   *0x20097a(%rip)        # 200fd0 &lt;__printf_chk@GLIBC_2.3.4&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 656:   68 01 00 00 00          pushq  $0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 65b:   e9 d0 ff ff ff          jmpq   630 &lt;.plt&gt;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>由于我们无论在内存什么位置加载该目标模块（包括共享目标模块），数据段与代码段的距离总是保持不变的。所以我们可以让处于代码段的plt函数通过距离常量来访问处于数据段中对应的got中保存的地址。
比如上面我们调用addvec@plt函数时，会执行0x640处的jmpq *0x200982(%rip)指令， 这里的0x200982就是上面所说的距离常量，用来指向特定的got项，这里可以得到访问的got项的地址为0x200982+0x646=0x200fc8，而该地址对应的got内容如下所示
<code>0x00200fc0 00000000 00000000 46060000 00000000 ........F.......</code>
根据小端法可以只为0x664，即跳转回到下一条指令，然后调用.plt函数</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000630 &lt;.plt&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 630:   ff 35 82 09 20 00       pushq  0x200982(%rip)        # 200fb8 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 636:   ff 25 84 09 20 00       jmpq   *0x200984(%rip)        # 200fc0 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 63c:   0f 1f 40 00             nopl   0x0(%rax)</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>其中第一条指令是将地址0x200982+0x636=0x200fb8作为参数压入栈中，而第二条指令是跳转到0x200984+0x63c=0x200fc0处保存的地址，我们通过上面可以看到，在未运行可执行目标文件时，该地址的值为0，而当运行了可执行目标文件时，该地址的值会修改到动态链接器中的_dl_runtime_resolve函数，来进行地址解析，查看共享库的addvec被加载到什么内存地址。那该函数是如何知道要获得哪个函数的地址，以及要将函数地址保存到哪个got项呢？</p><p>我们观察可执行目标文件中以下共享库的函数</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000640 &lt;addvec@plt&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 640:   ff 25 82 09 20 00       jmpq   *0x200982(%rip)        # 200fc8 &lt;addvec&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 646:   68 00 00 00 00          pushq  $0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 64b:   e9 e0 ff ff ff          jmpq   630 &lt;.plt&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000000650 &lt;__printf_chk@plt&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 650:   ff 25 7a 09 20 00       jmpq   *0x20097a(%rip)        # 200fd0 &lt;__printf_chk@GLIBC_2.3.4&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 656:   68 01 00 00 00          pushq  $0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 65b:   e9 d0 ff ff ff          jmpq   630 &lt;.plt&gt;</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>可以发现每个函数的第一条指令是跳转到对应的got项，而对应的got项被初始化为下一条指令的地址，当got项没有被修改时，就自动跳转到下一条指令。而第二条指令在不同函数中是不同的，其实对应的是.rela.plt的索引</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">Relocation section &#x27;.rela.plt&#x27; at offset 0x5e8 contains 2 entries:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000200fc8  000300000007 R_X86_64_JUMP_SLO 0000000000000000 addvec + 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000200fd0  000500000007 R_X86_64_JUMP_SLO 0000000000000000 __printf_chk@GLIBC_2.3.4 + 0</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>其中，offset表示对应的got项的地址，Sym.Name就是函数的名字。所以动态链接器通过索引值和.rela.plt数据组就能确定要定位哪个动态库函数，以及将其内存地址保存到哪个got项。</p><p>当动态链接后的addvec函数的内存地址保存到对应的got项时，下次再调用addvec函数时，就能直接通过该got项直接获得addvec函数的内存地址。</p><p>我们可以发现，第一次调用共享库的函数时，对应的xxx@plt函数并不会跳转到正确的函数地址，而是调用动态链接器来获得函数的地址，然后将其保存到got项中，下一次再运行时，才会跳转到正确的函数地址，该方法称为延迟绑定（Lazy Binding），只有共享库的函数要用时，才会重定位它的地址，否则不会，由此防止可执行目标文件加载时需要对大量的共享库的地址进行重定位。</p><p>综上所述：当函数要访问共享库中的函数时，实现执行call xxx@plt，访问该函数的封装函数，然后该plt函数会访问对应的got项，如果got项被赋值为对应的xxx函数的地址，则会调用该函数，否则会调用.plt<!-- -->[0]<!-- -->中的动态链接器，来定位xxx函数的内存地址，然后将其保存到对应的got项中。
因为 addcnt 是由 libvector.so 模块定义的，编译器可以利用代码段和数据段之间不变的距离，产生对 addcnt 的直接 PC 相对引用，并增加一个重定位，让链接器在构造这个共享模块时解析它。不过，如果 addcnt 是由另一个共享模块定义的，那么就需要通过 GOT 进行间接访问。在这里，编译器选择采用最通用的解决方案，为所有的引用使用 GOT。
<img loading="lazy" alt="img_9.png" src="/zh-CN/assets/images/img_9-d1d3c70726ac6a65c9a5585bcc6b97bc.png" width="778" height="932">
Step 1. Instead of directly calling addvec, the program calls into PLT<!-- -->[2]<!-- -->, which
is the PLT entry for addvec. \
Step 2. The first PLT instruction does an indirect jump through GOT<!-- -->[4]<!-- -->. Since
each GOT entry initially points to the second instruction in its correspond-
ing PLT entry, the indirect jump simply transfers control back to the next
instruction in PLT<!-- -->[2]<!-- -->. \
Step 3. After pushing an ID for addvec (0x1) onto the stack, PLT<!-- -->[2]<!-- --> jumps to
PLT<!-- -->[0]<!-- -->. \
Step 4. PLT<!-- -->[0]<!-- --> pushes an argument for the dynamic linker indirectly through
GOT<!-- -->[1]<!-- --> and then jumps into the dynamic linker indirectly through GOT<!-- -->[2]<!-- -->.
The dynamic linker uses the two stack entries to determine the run-
time location of addvec, overwrites GOT<!-- -->[4]<!-- --> with this address, and passes
control to addvec.
<img loading="lazy" alt="img_10.png" src="/zh-CN/assets/images/img_10-e75921c4e5bc39941f7a09e28cb31ce8.png" width="694" height="918">
Step 1. Control passes to PLT<!-- -->[2]<!-- --> as before.\
Step 2. However, this time the indirect jump through GOT<!-- -->[4]<!-- --> transfers control
directly to addvec.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="library-interpositioning">Library Interpositioning<a class="hash-link" href="#library-interpositioning" title="直接链接到标题">​</a></h4><p>library interpositioning,allows you to intercept calls to shared library functions and execute your own code instead.\
<strong>basic idea:</strong> Given some target function to be interposed on, you
create a wrapper function whose prototype is identical to the target function. Using
some particular interpositioning mechanism, you then trick the system into calling
the wrapper function instead of the target function. The wrapper function typically
executes its own logic, then calls the target function and passes its return value
back to the caller.</p><p>Interpositioning can occur at compile time, link time, or run time as the
program is being loaded and executed.
Example program int.c</p><div class="codeBlockContainer_I0IT language-code/link/interpose/int.c theme-code-block"><div class="codeBlockContent_wNvx code/link/interpose/int.c"><pre tabindex="0" class="prism-code language-code/link/interpose/int.c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;malloc.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int *p = malloc(32);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    free(p);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="1-compile-time-interpositioning">1. Compile-Time Interpositioning<a class="hash-link" href="#1-compile-time-interpositioning" title="直接链接到标题">​</a></h5><p>首先，我们可以定义一个本地的头文件malloc.h，如下所示
Local malloc.h file</p><div class="codeBlockContainer_I0IT language-code/link/interpose/malloc.h theme-code-block"><div class="codeBlockContent_wNvx code/link/interpose/malloc.h"><pre tabindex="0" class="prism-code language-code/link/interpose/malloc.h codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#define malloc(size) mymalloc(size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define free(ptr) myfree(ptr)</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>然后在编译int.c时，使用-I.编译选项，使得预处理器首先从本地查找malloc.h文件，由此就能将共享库的malloc和free函数替换成我们自己的mymalloc混合myfree函数。
而我们需要自己实现mymalloc和myfree函数，其中需要调用原始的malloc.h，由于malloc.h使用了#define指令，我们后面需要malloc的地方都会被mymalloc替代。
而mymalloc.c代码如下：
Wrapper functions in mymalloc.c</p><div class="codeBlockContainer_I0IT language-mymalloc.c theme-code-block"><div class="codeBlockContent_wNvx mymalloc.c"><pre tabindex="0" class="prism-code language-mymalloc.c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef COMPILETIME //编译选项是COMPILETIME ，这段代码才会编译进去</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;malloc.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* malloc wrapper function */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void *mymalloc(size_t size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void *ptr = malloc(size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;malloc(%d)=%p\n&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           (int)size, ptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* free wrapper function */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void myfree(void *ptr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    free(ptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;free(%p)\n&quot;, ptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;COMPILETIME\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>所以我们可以通过以下代码得到该函数的可重定位目标文件mymalloc.o </p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcc -DCOMPILETIME -c mymalloc.c</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>然后在本地的malloc.h中给出包装函数的函数原型，即</p><div class="codeBlockContainer_I0IT language-code/link/interpose/malloc.h theme-code-block"><div class="codeBlockContent_wNvx code/link/interpose/malloc.h"><pre tabindex="0" class="prism-code language-code/link/interpose/malloc.h codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#define malloc(size) mymalloc(size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define free(ptr) myfree(ptr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void *mymalloc(size_t size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void myfree(void *ptr);</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>然后就可以通过以下命令行进行编译时打桩</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcc -I. -o intc int.c mymalloc.o</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>此时，由于-I.编译选项，对于int.c中的malloc.h，预处理器会首先从本地搜索malloc.h文件，而在本地malloc.h文件中，对malloc和free函数重新包装成mymalloc和myfree函数，而这两个函数在之前编译好的mymalloc.o可重定位目标文件中，此时就完成了编译时打桩。</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">0x558ca12fc2a0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x558ca12fc2a0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COMPILETIME</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>使用malloc的地方，都被替换成了mymalloc。</p><div class="codeBlockContainer_I0IT language-int.i theme-code-block"><div class="codeBlockContent_wNvx int.i"><pre tabindex="0" class="prism-code language-int.i codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">void *mymalloc(size_t size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void myfree(void *ptr);</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="2-link-time-interpositioning">2. Link-Time Interpositioning<a class="hash-link" href="#2-link-time-interpositioning" title="直接链接到标题">​</a></h5><p>Linux静态链接器也支持使用--wrap f标志进行链接时打桩，此时会将符号f解析为<strong>wrap_f，而将对</strong>real_f符号的引用解析为f， 意味着原始对函数f的调用，还会替换成对<strong>wrap_f函数的调用，而通过</strong>real_f函数来调用原始函数f。
我们定义以下函数</p><div class="codeBlockContainer_I0IT language-mymalloc.c theme-code-block"><div class="codeBlockContent_wNvx mymalloc.c"><pre tabindex="0" class="prism-code language-mymalloc.c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef LINKTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void *__real_malloc(size_t size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void __real_free(void *ptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* malloc wrapper function */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void *__wrap_malloc(size_t size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void *ptr = __real_malloc(size); /* Call libc malloc */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;malloc(%d) = %p\n&quot;, (int)size, ptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* free wrapper function */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void __wrap_free(void *ptr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __real_free(ptr); /* Call libc free */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;free(%p)\n&quot;, ptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;LINKTIME\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>同时进行编译</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcc -DLINKTIME -Wl,--wrap,malloc -Wl,--wrap,free -o intl int.c mymalloc.c</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>也可以分开编译</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcc -DLINKTIME -c mymalloc.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcc -c int.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gcc -Wl,--wrap,malloc -Wl,--wrap,free -o intl int.o mymalloc.o</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>-Wl,option 把标志 option 传递给链接器。option中的每个逗号都要替换为一个空格。所以 -Wl,--wrap,malloc 就把 --wrap malloc 传递给链接器，以类似的方式传递 -Wl,--wrap,free。 </p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">0x558ca12fc2a0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x558ca12fc2a0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LINKTIME</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>由此，利用链接器的打桩机制, int.c中对malloc和free函数的调用，会变成对<strong>wrap_malloc和</strong>wrap_free函数的调用。而__real_malloc将会被解析成真正的malloc。</p><p>综上所述：想要在链接时打桩，意味着在对可重定位目标文件的符号进行解析时，进行替换。</p><h5 class="anchor anchorWithStickyNavbar_mojV" id="3-run-time-interpositioning">3. Run-Time Interpositioning<a class="hash-link" href="#3-run-time-interpositioning" title="直接链接到标题">​</a></h5><p>运行时进行打桩，意味着是对共享库的函数进行打桩，这里使用动态链接器提供的LD_PRELOAD环境变量，通过该变量设置共享库路径列表，执行可执行目标文件时，动态链接器就会先搜索LD_PRELOAD共享库。
定义以下函数</p><div class="codeBlockContainer_I0IT language-mymalloc.c theme-code-block"><div class="codeBlockContent_wNvx mymalloc.c"><pre tabindex="0" class="prism-code language-mymalloc.c codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">#ifdef RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#define _GNU_SOURCE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdio.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;stdlib.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;dlfcn.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* malloc wrapper function */而__real_malloc将会被解析成真正的malloc。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void *malloc(size_t size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void *(*mallocp)(size_t size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *error;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mallocp = dlsym(RTLD_NEXT, &quot;malloc&quot;); /* Get address of libc   malloc */ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ((error = dlerror()) != NULL) { </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fputs(error, stderr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exit(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *ptr = mallocp(size); /* Call libc malloc */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//  printf(&quot;malloc(%d) = %p\n&quot;, (int)size, ptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return ptr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* free wrapper function */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void free(void *ptr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void (*freep)(void *) = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    char *error;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!ptr)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    freep = dlsym(RTLD_NEXT, &quot;free&quot;); /* Get address of libc free */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if ((error = dlerror()) != NULL) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fputs(error, stderr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exit(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    freep(ptr); /* Call libc free */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;free(%p)\n&quot;, ptr);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    printf(&quot;RUNTIME\n&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#endif</span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>然后通过以下命令行将其编译成共享库</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcc -DRUNTIME -shared -fpic -o mymalloc.so mymalloc.c -ldl </span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>然后编译，在运行时指定环境变量LD_PRELOAD</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">gcc -o intr int.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">LD_PRELOAD</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;./mymalloc.so&quot;</span><span class="token plain"> ./intr </span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>此时运行到malloc和free函数时，就会调用动态链接器搜索该符号的定义，此时会先搜索LD_PRELOAD指定的共享库，而mymalloc.so中定义了这两个符号，所以就替换了这两个函数的具体实现。注意：如果想要调用原始的定义，就需要用运行动态链接的方式，通过指定dlsym的参数为RTLD_NEXT，来在后续的共享库中获得malloc的定义。 </p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">&quot;./mymalloc.so&quot;</span><span class="token plain"> ./intr </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">0x55a98bc572a0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUNTIME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="复制代码到剪贴板" class="copyButton_wuS7 clean-btn">复制</button></div></div><p>GNU binutils 包尤其有帮助，而且可以运行在每个 Linux 平台上。
AR：创建静态库，插入、删除、列出和提取成员。
STRINGS：列出一个目标文件中所有可打印的字符串。
STRIP：从目标文件中删除符号表信息。
NM：列出一个目标文件的符号表中定义的符号。
SIZE：列出目标文件中节的名字和大小。
READELF：显示一个目标文件的完整结构，包括 ELF 头中编码的所有信息。包含 SIZE 和 NM 的功能。
OBJDUMP：所有二进制工具之母。能够显示一个目标文件中所有的信息。它最大的作用是反汇编 .text 节中的二进制指令。
Linux 系统为操作共享库还提供了 LDD 程序：
LDD：列出一个可执行文件在运行时所需要的共享库。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/Malaaaa/blog-sample/tree/main/docs/CSAPP/Linking.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页面</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档页面导航"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh-CN/docs/CSAPP/I/O"><div class="pagination-nav__sublabel">前一个</div><div class="pagination-nav__label">O</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh-CN/docs/CSAPP/Network"><div class="pagination-nav__sublabel">下一个</div><div class="pagination-nav__label">Network</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#translates-the-example-program-from-an-ascii-source-file-into-an-executable-object-file" class="table-of-contents__link toc-highlight">Translates the example program from an ASCII source file into an executable object file.</a></li><li><a href="#object-files" class="table-of-contents__link toc-highlight">Object Files</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">版权 © 2022 Malaaa site。使用 Docusaurus 构建。</div></div></div></footer></div>
<script src="/zh-CN/assets/js/runtime~main.89956f3e.js"></script>
<script src="/zh-CN/assets/js/main.90a4a23c.js"></script>
</body>
</html>